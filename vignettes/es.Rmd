---
title: "ExpressionSet usage"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
    check_title: false
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{ExpressionSet usage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
set.seed(0)
knitr::opts_chunk$set(
  out.extra = 'style="display:block; margin: auto"',
  fig.align = "center",
  fig.path = "es/",
  collapse = TRUE,
  comment = "#>",
  dev = "png")
```

```{r, message=FALSE, warning=FALSE}
pkgs <- c("Biobase", "arrayQualityMetrics", "knitr", "pQTLtools")
for (p in pkgs) if (length(grep(paste("^package:", p, "$", sep=""), search())) == 0) {
    if (!requireNamespace(p)) warning(paste0("This vignette needs package `", p, "'; please install"))
}
invisible(suppressMessages(lapply(pkgs, require, character.only = TRUE)))
```

We illustrate Bioconductor/Biobase's ExpressionSet with its example and finish with a real example. See also the reference section.

```{r, results='hide'}
dataDirectory <- system.file("extdata", package="Biobase")
exprsFile <- file.path(dataDirectory, "exprsData.txt")
exprs <- as.matrix(read.table(exprsFile, header=TRUE, sep="\t", row.names=1, as.is=TRUE))
pDataFile <- file.path(dataDirectory, "pData.txt")
pData <- read.table(pDataFile, row.names=1, header=TRUE, sep="\t")
all(rownames(pData)==colnames(exprs))
metadata <- data.frame(labelDescription=
                       c("Patient gender",
                         "Case/control status",
                         "Tumor progress on XYZ scale"),
                       row.names=c("gender", "type", "score"))
phenoData <- new("AnnotatedDataFrame", data=pData, varMetadata=metadata)
experimentData <- new("MIAME",
  name="Pierre Fermat",
  lab="Francis Galton Lab",
  contact="pfermat@lab.not.exist",
  title="Smoking-Cancer Experiment",
  abstract="An example ExpressionSet",
  url="www.lab.not.exist",
  other=list(notes="Created from text files"))
exampleSet <- make_ExpressionSet(exprs,phenoData,experimentData=experimentData,
                                 annotation="hgu95av2")
data(sample.ExpressionSet)
identical(exampleSet,sample.ExpressionSet)
```

## data.frame

The great benefit is to use the object directly as a data.frame.

```{r}
lm.result <- esApply(exampleSet,1,function(x) lm(score~gender+x))
beta.x <- unlist(lapply(lapply(lm.result,coef),"[",3))
beta.x[1]
lm(score~gender+AFFX.MurIL2_at,data=exampleSet)
```

## Composite plots

We wish to examine the distribution of each feature via histogram, scatter and boxplot.
One could resort to `esApply` for its simplicity as before

```r
invisible(esApply(exampleSet[1:2],1,function(x){par(mfrow=c(3,1));boxplot(x);hist(x);plot(x)}))
```
but it is nicer to add feature name in the title.

```{r plots, fig.height=12}
f <- featureNames(exampleSet[1:2])
invisible(sapply(f,function(x) {
                     d <- t(exprs(exampleSet[x]))
                     fn <- featureNames(exampleSet[x])
                     par(mfrow=c(3,1))
                     hist(d,main="",xlab=fn); plot(d, ylab=fn); boxplot(d,ylab=fn)
                   }
          )
)
```
where the expression set is indexed using feature name(s).

## Outlier detections

This illustrates one mechanism,

```r
list_outliers <- function(es, method="upperquartile") outliers(exprs(es),method=method)
for (method in c("KS","sum","upperquartile"))
{
  ZWK_outliers <- list_outliers(protein_ZWK,method=method)
  print(ZWK_outliers@statistic[ZWK_outliers@which])
}
```

## Data transformation

Suppose we wish use log2 for those greater than zero but set those negative values to be missing.

```r
log2.na <- function(x) log2(ifelse(x>0, x, NA))
exprs(exampleSet) <- log2.na(exprs(exampleSet))
```

## Limit of detection (LOD)

We generate a `lod.max` ~ U[0,1] variable to experiment

```{r test, fig.height=7}
fData(exampleSet)
fData(exampleSet)$lod.max <- apply(exprs(exampleSet),1,quantile,runif(nrow(exampleSet)))
lod <- get.prop.below.LLOD(exampleSet)
x <- dplyr::arrange(fData(lod),desc(pc.belowLOD.new))
kable(head(lod))
plot(x[,2], main="Random quantile cut off", ylab="<lod%")
```

The quantity has been shown to have a big impact on protein abundance and therefore pQTL detection as is shown with a real example.

```r
rm(list=ls())
dir <- "~/rds/post_qc_data/interval/phenotype/olink_proteomics/post-qc/"
eset <- readRDS(paste0(dir,"eset.inf1.flag.out.outlier.in.rds"))
x <- get.prop.below.LLOD(eset)
annot <- fData(x)
annot$MissDataProp <- as.numeric(gsub("\\%$", "", annot$MissDataProp))
plot(annot$MissDataProp, annot$pc.belowLOD.new, xlab="% <LLOD in Original",
     ylab="% <LLOD in post QC dataset", pch=19)
INF <- Sys.getenv("INF")
np <- read.table(paste(INF, "work", "INF1.merge.nosig", sep="/"), header=FALSE,
                 col.names = c("prot", "uniprot"))
kable(np, caption="Proteins with no pQTL")
annot$pQTL <- rep(NA, nrow(annot))
no.pQTL.ind <- which(annot$uniprot.id %in% np$uniprot)
annot$pQTL[no.pQTL.ind] <- "red"
annot$pQTL[-no.pQTL.ind] <- "blue"
annot <- annot[order(annot$pc.belowLOD.new, decreasing = TRUE),]
annot <- annot[-grep("^BDNF$", annot$ID),]
saveRDS(annot,file=file.path("~","pQTLtools","tests","annot.RDS"))
```

```{r lod, fig.height=7}
annot <- readRDS(file.path("~","pQTLtools","tests","annot.RDS"))
annot <- within(annot,{prot=gsub("^[0-9]*_","",olink.id)})
par(mar=c(5,4,1,1))
attach(annot)
ytick <- seq(1, nrow(annot))
plot(100-pc.belowLOD.new,ytick,cex=0.8,pch=19,col=pQTL,axes=FALSE, xlab="", ylab="", cex.lab=0.8)
axis(1, cex.axis=0.6)
axis(2, at=ytick, labels = FALSE, lwd.tick=0.1, lwd=0)
text(y=ytick, par("usr")[3],labels = prot, srt = 25, pos = 1, xpd = TRUE, cex=0.5)
mtext("100-% samples with very low abundance per protein",side=1,line=2.5,cex=1.2)
mtext("Ordered proteins",side=2,line=2.5,cex=0.9,font=2)
legend(x=55,y=20,c("without pQTL","with pQTL"),box.lwd=0,cex=1.2,col=c("red","blue"),pch=19)
detach(annot)
options(width=120)
kable(annot,caption="Summary statistics",row.names=FALSE)
```

## Combination of proteins and other variables

This is available by design.

## maEndtoEnd

Web: [https://bioconductor.org/packages/release/workflows/html/maEndToEnd.html](https://bioconductor.org/packages/release/workflows/html/maEndToEnd.html).

Examples can be found on PCA, heatmap, normalisation, linear models, and enrichment analysis from this Bioconductor package.

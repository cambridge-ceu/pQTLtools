---
title: "ExpressionSet"
author: "Jing Hua Zhao"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
    check_title: false
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{ExpressionSet}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
set.seed(0)
knitr::opts_chunk$set(
  out.extra = 'style="display:block; margin: auto"',
  fig.align = "center",
  fig.path = "es/",
  collapse = TRUE,
  comment = "#>",
  dev = "png")
```

We illustrate Bioconductor/Biobase's ExpressionSet with its example, see also the reference section.

```{r, results='hide'}
dataDirectory <- system.file("extdata", package="Biobase")
exprsFile <- file.path(dataDirectory, "exprsData.txt")
exprs <- as.matrix(read.table(exprsFile, header=TRUE, sep="\t", row.names=1, as.is=TRUE))
pDataFile <- file.path(dataDirectory, "pData.txt")
pData <- read.table(pDataFile, row.names=1, header=TRUE, sep="\t")
all(rownames(pData)==colnames(exprs))
metadata <- data.frame(labelDescription=
                       c("Patient gender",
                         "Case/control status",
                         "Tumor progress on XYZ scale"),
                       row.names=c("gender", "type", "score"))
require(Biobase)
require(pQTLtools)
phenoData <- new("AnnotatedDataFrame", data=pData, varMetadata=metadata)
experimentData <- new("MIAME",
  name="Pierre Fermat",
  lab="Francis Galton Lab",
  contact="pfermat@lab.not.exist",
  title="Smoking-Cancer Experiment",
  abstract="An example ExpressionSet",
  url="www.lab.not.exist",
  other=list(notes="Created from text files"))
exampleSet <- make_ExpressionSet(exprs,phenoData,experimentData,annotation="hgu95av2")
data(sample.ExpressionSet)
identical(exampleSet,sample.ExpressionSet)
```

## data.frame

The great benefit is to use the object directly as a data.frame.

```{r}
lm.result <- esApply(exampleSet,1,function(x) lm(score~x))
beta.x <- unlist(lapply(lapply(lm.result,coef),"[",2))
beta.x[1]
lm(score~AFFX.MurIL2_at,data=as.data.frame(exampleSet))
```

## Composite plots

We wish to examine the distribution of each feature via histogram, scatter and boxplot.
One could resort to `esApply` for it simplicity as before

```r
invisible(esApply(exampleSet[1:5],1,function(x){par(mfrow=c(3,1));boxplot(x);hist(x);plot(x)}))
```
but it is nicer to add feature name in the title.

```{r, fig.height=12}
fn <-featureNames(exampleSet[1:5])
sapply(fn,function(x) {
     d <- t(exprs(exampleSet[x]))
     t <- featureNames(exampleSet[x])
     par(mfrow=c(3,1))
     hist(d,main=t);
     plot(d, ylab=t);
     boxplot(d)
   })
```
where the expression set is indexed using feature name(s).

## Data transformation

Suppose we wish use log2 for those greater than zero but set those negative values to be missing.

```r
log2.na <- function(x) log2(ifelse(x>0, x, NA))
exprs(exampleSet) <- log2.na(exprs(exampleSet))
```

## Limit of detection (LOD)

The quantity has been shown to have a bit impact on protein abundance and therefore pQTL detection.
